$(document).ready(function(){function e(e){return[Math.floor((e.clientX+container.scrollLeft)/l),Math.floor((e.clientY+container.scrollTop)/l)]}function t(e){return[Math.floor((e.clientX+container.scrollLeft)/l/8),Math.floor((e.clientY+container.scrollTop)/l/8)]}function o(e){var t=8*e[0],o=8*e[1];return function(e){var t,o=0,a=[];for(t=0;t<e.length;t++)t%4==0&&(a[o]=e[t]+","+e[t+1]+","+e[t+2]+","+e[t+3],o++);return uniqueItems=[],$.each(a,function(e,t){-1===$.inArray(t,uniqueItems)&&uniqueItems.push(t)}),uniqueItems}(s.getImageData(t,o,8,8).data)}function a(){i.getContext("2d").drawImage(c,0,0)}function n(n){var r=e(n),c=t(n),i=o(c),l=r[0]-8*c[0]+8*(r[1]-8*c[1]);if(i.length<2||g+",255"==i[0]||g+",255"==i[1]||0==f){if(1==p&&-1!=$.inArray(l,ditherBrushArray))return!1;!function(e,t,o){s.putImageData(u,e,t),s.fillStyle="rgba("+o+",1)",s.fillRect(e,t,1,1)}(r[0],r[1],g)}else!function(e,t,o){var a=8*e[0],n=8*e[1],r=s.getImageData(a,n,8,8),c=0,i=[];for(data=r.data,h=0;h<data.length;h++)h%4==0&&(i[c]=data[h]+","+data[h+1]+","+data[h+2]+","+data[h+3],c++);for(colorToChange=i[t],h=0;h<i.length;h++)i[h]==colorToChange&&(i[h]=g+",255");var l=[],c=0;$.each(i,function(e,t){var o=i[e].split(",");for(h=0;h<o.length;h++)l[c]=o[h],c++});for(var h=0;h<r.data.length;h++)r.data[h]=l[h];s.putImageData(r,a,n)}(c,l);a()}window.addEventListener("beforeunload",function(e){return e.returnValue="Are you sure you want to leave the page?","Are you sure you want to leave the page?"}),$("#preview-canvas-container, #palette-container, #options-container, #zoom").draggable({handle:"h1"});var r=["0,0,0","255,255,255","103,55,43","112,164,178","111,61,134","88,141,67","53,40,121","184,199,111","111,79,37","67,57,0","154,103,89","68,68,68","108,108,108","154,210,132","108,94,181","149,149,149"],c=document.getElementById("canvas"),i=document.getElementById("preview-canvas"),s=c.getContext("2d"),l=32,h=1,d=!1,u=s.createImageData(1,1),v=(u.data,!1),g="0,0,0",f=!0,p=!1,m=[1,3,5,7,8,10,12,14,17,19,21,23,24,26,28,30,33,35,37,39,40,42,44,46,49,51,53,55,56,58,60,62];$("#brush_1").on("click",function(){$(this).hasClass("active")?(p=!1,ditherBrushArray=[],$(this).removeClass("active")):(p=!0,ditherBrushArray=m,$(this).addClass("active"))}),$("#canvas").css("zoom",l),$("#preview-canvas").css("zoom",h),$("#hires-limit").on("change",function(){$(this).is(":checked")?(f=!0,$(".current-colors-container").show()):(f=!1,$(".current-colors-container").hide())}),$("#zoom-level, #zoom span").text(l),$(window).on("resize load",function(){$("#container").css("width",$(window).width()+"px").css("height",$(window).height()+"px")}),$(window).on("load",function(){$("#container").scrollLeft(($("#canvas").width()*l-$(window).width())/2),$("#container").scrollTop(($("#canvas").height()*l-$(window).height())/2)});var w,x="";for(w=0;w<r.length;++w)x+='<div class="color'+(0==w?" active":"")+'" data-rgb="'+r[w]+'" style="background-color: rgba('+r[w]+',1)"></div>';$("#palette").append(x);var y=new Image;y.src="demopic.png",y.onload=function(){s.drawImage(y,0,0),a()},$("#clear").on("click",function(){s.save(),s.setTransform(1,0,0,1,0,0),s.clearRect(0,0,c.width,c.height),s.fillStyle="rgba("+g+",1)",s.fillRect(0,0,c.width,c.height),s.restore(),a()}),$(c).bind({mousedown:function(){v=!0,n(event)},mousemove:function(){var r=e(event);$("#coor-x").text(r[0]),$("#coor-y").text(r[1]);var c=t(event);$("#charcoor-x").text(c[0]+1),$("#charcoor-y").text(c[1]+1),$("#char-overlay").css("top",c[1]*l*8+"px").css("left",c[0]*l*8+"px").css("width",8*l-1+"px").css("height",8*l-1+"px");var i=o(c);1==i.length&&(i[1]=i[0]),$("#current-colors .color1").css("background-color","rgba("+i[0]+")"),$("#current-colors .color2").css("background-color","rgba("+i[1]+")"),v&&(n(event),a())},mouseup:function(){v=!1}}),$(".zoom-option").on("click",function(){$(this).hasClass("zoom-in")?zoomIndex=4:zoomIndex=4==l?0:-4,$("#canvas").css("zoom",l+zoomIndex),l+=zoomIndex,$("#zoom-level, #zoom span").text(l);var e=t(event);$("#char-overlay").css("top",e[1]*l*8+"px").css("left",e[0]*l*8+"px").css("width",8*l-1+"px").css("height",8*l-1+"px"),l<4?$("#char-overlay").css("background-color","rgba(255,255,255,0.1)"):$("#char-overlay").css("background","none")}),$("#preview-canvas").on("click",function(){event.stopPropagation(),d=!0,$("#preview-canvas").addClass("active")}),$(window).click(function(){d=!1,$("#preview-canvas").removeClass("active")}),$("#preview-canvas").bind("mousewheel",function(e){var t=e.originalEvent.wheelDelta;h+t>1?($(this).css("zoom",h+.5),h+=.5,$("#preview-canvas-container h1 span em").text(h)):($(this).css("zoom",1),h=1,$("#preview-canvas-container h1 span em").text(h))}),$("#palette .color").on("click",function(){g=$(this).data("rgb"),$("#palette .color").removeClass("active"),$(this).addClass("active")})});