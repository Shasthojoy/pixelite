$(document).ready(function(){function e(e){return[Math.floor((e.clientX+container.scrollLeft)/l),Math.floor((e.clientY+container.scrollTop)/l)]}function o(e){return[Math.floor((e.clientX+container.scrollLeft)/l/8),Math.floor((e.clientY+container.scrollTop)/l/8)]}function t(e){var o=8*e[0],t=8*e[1];return function(e){var o,t=0,n=[];for(o=0;o<e.length;o++)o%4==0&&(n[t]=e[o]+","+e[o+1]+","+e[o+2]+","+e[o+3],t++);return uniqueItems=[],$.each(n,function(e,o){-1===$.inArray(o,uniqueItems)&&uniqueItems.push(o)}),uniqueItems}(s.getImageData(o,t,8,8).data)}function n(){i.getContext("2d").drawImage(r,0,0)}function a(a){var c=e(a),r=o(a),i=t(r),l=c[0]-8*r[0]+8*(c[1]-8*r[1]);i.length<2||g+",255"==i[0]||g+",255"==i[1]||0==p?function(e,o,t){s.putImageData(v,e,o),s.fillStyle="rgba("+t+",1)",s.fillRect(e,o,1,1)}(c[0],c[1],g):function(e,o,t){var n=8*e[0],a=8*e[1],c=s.getImageData(n,a,8,8),r=0,i=[];for(data=c.data,d=0;d<data.length;d++)d%4==0&&(i[r]=data[d]+","+data[d+1]+","+data[d+2]+","+data[d+3],r++);for(colorToChange=i[o],d=0;d<i.length;d++)i[d]==colorToChange&&(i[d]=g+",255");var l=[],r=0;$.each(i,function(e,o){var t=i[e].split(",");for(d=0;d<t.length;d++)l[r]=t[d],r++});for(var d=0;d<c.data.length;d++)c.data[d]=l[d];s.putImageData(c,n,a)}(r,l),n()}$("#preview-canvas-container, #palette-container, #options-container, #zoom").draggable({handle:"h1"});var c=["0,0,0","255,255,255","103,55,43","112,164,178","111,61,134","88,141,67","53,40,121","184,199,111","111,79,37","67,57,0","154,103,89","68,68,68","108,108,108","154,210,132","108,94,181","149,149,149"],r=document.getElementById("canvas"),i=document.getElementById("previewCanvas"),s=r.getContext("2d"),l=24,d=1,h=!1,v=s.createImageData(1,1),u=(v.data,!1),g="0,0,0",p=!0;$("#hires-limit").on("change",function(){$(this).is(":checked")?(p=!0,$(".current-colors-container").show()):(p=!1,$(".current-colors-container").hide())}),$("#zoom-level, #zoom span").text(l),$(window).on("resize load",function(){$("#container").css("width",$(window).width()+"px").css("height",$(window).height()+"px")}),$(window).on("load",function(){$("#container").scrollLeft(($("#canvas").width()*l-$(window).width())/2),$("#container").scrollTop(($("#canvas").height()*l-$(window).height())/2)});var f,m="";for(f=0;f<c.length;++f)m+='<div class="color'+(0==f?" active":"")+'" data-rgb="'+c[f]+'" style="background-color: rgba('+c[f]+',1)"></div>';$("#palette").append(m);var w=new Image;w.src="demopic.png",w.onload=function(){s.drawImage(w,0,0),n()},$("#options-container select").on("change",function(){w.src=this.value+".png",s.drawImage(w,0,0),n()}),$("#clear").on("click",function(){s.save(),s.setTransform(1,0,0,1,0,0),s.clearRect(0,0,r.width,r.height),s.fillStyle="rgba("+g+",1)",s.fillRect(0,0,r.width,r.height),s.restore(),n()}),$(r).bind({mousedown:function(){u=!0,a(event)},mousemove:function(){var c=e(event);$("#coor-x").text(c[0]),$("#coor-y").text(c[1]);var r=o(event);$("#charcoor-x").text(r[0]+1),$("#charcoor-y").text(r[1]+1),$("#char-overlay").css("top",r[1]*l*8+"px").css("left",r[0]*l*8+"px").css("width",8*l-1+"px").css("height",8*l-1+"px");var i=t(r);1==i.length&&(i[1]=i[0]),$("#current-colors .color1").css("background-color","rgba("+i[0]+")"),$("#current-colors .color2").css("background-color","rgba("+i[1]+")"),u&&(a(event),n())},mouseup:function(){u=!1}}),$(".zoom-option").on("click",function(){$(this).hasClass("zoom-in")?zoomIndex=4:zoomIndex=4==l?0:-4,$("#canvas").css("zoom",l+zoomIndex),l+=zoomIndex,$("#zoom-level, #zoom span").text(l);var e=o(event);$("#char-overlay").css("top",e[1]*l*8+"px").css("left",e[0]*l*8+"px").css("width",8*l-1+"px").css("height",8*l-1+"px"),l<4?$("#char-overlay").css("background-color","rgba(255,255,255,0.1)"):$("#char-overlay").css("background","none")}),$("#previewCanvas").on("click",function(){event.stopPropagation(),h=!0,$("#previewCanvas").addClass("active")}),$(window).click(function(){h=!1,$("#previewCanvas").removeClass("active")}),$("#previewCanvas").bind("mousewheel",function(e){var o=e.originalEvent.wheelDelta;d+o>1?($("#previewCanvas").css("zoom",d+.5),d+=.5,$("#preview-canvas-container h1 span em").text(d)):($("#previewCanvas").css("zoom",1),d=1,$("#preview-canvas-container h1 span em").text(d))}),$("#palette .color").on("click",function(){g=$(this).data("rgb"),$("#palette .color").removeClass("active"),$(this).addClass("active")})});