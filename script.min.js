$(document).ready(function(){function e(e){return[Math.floor((e.clientX+container.scrollLeft)/s),Math.floor((e.clientY+container.scrollTop)/s)]}function a(e){return[Math.floor((e.clientX+container.scrollLeft)/s/8),Math.floor((e.clientY+container.scrollTop)/s/8)]}function t(e){var a=8*e[0],t=8*e[1];return function(e){var a,t=0,n=[];for(a=0;a<e.length;a++)a%4==0&&(n[t]=e[a]+","+e[a+1]+","+e[a+2]+","+e[a+3],t++);return uniqueItems=[],$.each(n,function(e,a){-1===$.inArray(a,uniqueItems)&&uniqueItems.push(a)}),uniqueItems}(i.getImageData(a,t,8,8).data)}function n(){l.getContext("2d").drawImage(c,0,0)}function o(o){var r=e(o),c=a(o),l=t(c),s=r[0]-8*c[0]+8*(r[1]-8*c[1]);l.length<2||g+",255"==l[0]||g+",255"==l[1]?function(e,a,t){i.putImageData(h,e,a),i.fillStyle="rgba("+t+",1)",i.fillRect(e,a,1,1)}(r[0],r[1],g):function(e,a,t){var n=8*e[0],o=8*e[1],r=i.getImageData(n,o,8,8),c=0,l=[];for(data=r.data,v=0;v<data.length;v++)v%4==0&&(l[c]=data[v]+","+data[v+1]+","+data[v+2]+","+data[v+3],c++);for(colorToChange=l[a],v=0;v<l.length;v++)l[v]==colorToChange&&(l[v]=g+",255");var s=[],c=0;$.each(l,function(e,a){var t=l[e].split(",");for(v=0;v<t.length;v++)s[c]=t[v],c++});for(var v=0;v<r.data.length;v++)r.data[v]=s[v];i.putImageData(r,n,o)}(c,s),n()}$("#preview-canvas-container, #palette-container, #options-container").draggable({handle:"h1"});var r=["0,0,0","255,255,255","103,55,43","112,164,168","111,61,134","88,141,67","53,40,121","184,199,111","111,79,37","67,57,0","154,103,89","68,68,68","108,108,108","154,210,132","108,94,181","149,149,149"],c=document.getElementById("canvas"),l=document.getElementById("previewCanvas"),i=c.getContext("2d"),s=12,v=1,u=!1,h=i.createImageData(1,1),d=(h.data,!1),g="0,0,0";$("#zoom-level").val(s),$(window).on("resize load",function(){$("#container").css("width",$(window).width()+"px").css("height",$(window).height()+"px")});var f,p="";for(f=0;f<r.length;++f)p+='<div class="color'+(0==f?" active":"")+'" data-rgb="'+r[f]+'" style="background-color: rgba('+r[f]+',1)"></div>';$("#palette").append(p);var w=new Image;w.src="img1.png",w.onload=function(){i.drawImage(w,0,0),n()},$("#options-container select").on("change",function(){w.src=this.value+".png",i.drawImage(w,0,0),n()}),$("#clear").on("click",function(){i.save(),i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,c.width,c.height),i.fillStyle="rgba("+g+",1)",i.fillRect(0,0,c.width,c.height),i.restore(),n()}),$(c).bind({mousedown:function(){d=!0,o(event)},mousemove:function(){var r=e(event);$("#coor-x").val(r[0]),$("#coor-y").val(r[1]);var c=a(event);$("#charcoor-x").val(c[0]+1),$("#charcoor-y").val(c[1]+1),$("#char-overlay").css("top",c[1]*s*8+"px").css("left",c[0]*s*8+"px").css("width",8*s-1+"px").css("height",8*s-1+"px");var l=t(c);1==l.length&&(l[1]=l[0]),$("#current-colors .color1").css("background-color","rgba("+l[0]+")"),$("#current-colors .color2").css("background-color","rgba("+l[1]+")"),d&&(o(event),n())},mouseup:function(){d=!1}}),c.onmousewheel=function(e){var t=e.wheelDelta/240;$("#canvas").css("zoom",s+t),s+=t,$("#zoom-level").val(s);var n=a(e);$("#char-overlay").css("top",n[1]*s*8+"px").css("left",n[0]*s*8+"px").css("width",8*s-1+"px").css("height",8*s-1+"px"),s<4?$("#char-overlay").css("background-color","rgba(255,255,255,0.1)"):$("#char-overlay").css("background","none")},$("#previewCanvas").on("click",function(){event.stopPropagation(),u=!0,$("#previewCanvas").addClass("active")}),$(window).click(function(){u=!1,$("#previewCanvas").removeClass("active")}),$("#previewCanvas").bind("mousewheel",function(e){var a=e.originalEvent.wheelDelta;v+a>1?($("#previewCanvas").css("zoom",v+.5),v+=.5,$("#preview-canvas-container h1 span em").text(v)):($("#previewCanvas").css("zoom",1),v=1,$("#preview-canvas-container h1 span em").text(v))}),$(window).on("wheel mousewheel",function(e){e.originalEvent.deltaY>0?e.preventDefault():e.originalEvent.wheelDeltaY<0&&e.preventDefault()}),$("#palette .color").on("click",function(){g=$(this).data("rgb"),$("#palette .color").removeClass("active"),$(this).addClass("active")})});