$(document).ready(function(){function e(e){e.hasClass("active")?(b=!1,ditherBrushArray=[],e.removeClass("active")):(b=!0,ditherBrushArray=x,e.addClass("active"))}function t(e){return[Math.floor((e.clientX+container.scrollLeft)/u),Math.floor((e.clientY+container.scrollTop)/u)]}function o(e){return[Math.floor((e.clientX+container.scrollLeft)/u/8),Math.floor((e.clientY+container.scrollTop)/u/8)]}function a(e){var t=8*e[0],o=8*e[1];return function(e){var t,o=0,a=[];for(t=0;t<e.length;t++)t%4==0&&(a[o]=e[t]+","+e[t+1]+","+e[t+2]+","+e[t+3],o++);return uniqueItems=[],$.each(a,function(e,t){-1===$.inArray(t,uniqueItems)&&uniqueItems.push(t)}),uniqueItems}(d.getImageData(t,o,8,8).data)}function n(){l.getContext("2d").drawImage(s,0,0)}function c(e){var c=t(e),r=o(e),i=a(r),s=c[0]-8*r[0]+8*(c[1]-8*r[1]);if(f=3==e.which?p:f,i.length<2||f+",255"==i[0]||f+",255"==i[1]||0==w){if(1==b&&-1!=$.inArray(s,ditherBrushArray))return!1;!function(e,t,o){d.putImageData(g,e,t),d.fillStyle="rgba("+o+",1)",d.fillRect(e,t,1,1)}(c[0],c[1],f)}else!function(e,t,o){var a=8*e[0],n=8*e[1],c=d.getImageData(a,n,8,8),r=0,i=[];for(data=c.data,l=0;l<data.length;l++)l%4==0&&(i[r]=data[l]+","+data[l+1]+","+data[l+2]+","+data[l+3],r++);for(colorToChange=i[t],l=0;l<i.length;l++)i[l]==colorToChange&&(i[l]=f+",255");var s=[],r=0;$.each(i,function(e,t){var o=i[e].split(",");for(l=0;l<o.length;l++)s[r]=o[l],r++});for(var l=0;l<c.data.length;l++)c.data[l]=s[l];d.putImageData(c,a,n)}(r,s);f=$(".color-indicators .left-click").data("rgb"),p=$(".color-indicators .right-click").data("rgb"),n()}window.addEventListener("beforeunload",function(e){return e.returnValue="Are you sure you want to leave the page?","Are you sure you want to leave the page?"}),document.addEventListener("contextmenu",function(e){e.preventDefault()},!1),$("#preview-canvas-container, #palette-container, #options-container, #zoom").draggable({handle:"h1"});var r,i=["0,0,0","255,255,255","103,55,43","112,164,178","111,61,134","88,141,67","53,40,121","184,199,111","111,79,37","67,57,0","154,103,89","68,68,68","108,108,108","154,210,132","108,94,181","149,149,149"],s=document.getElementById("canvas"),l=document.getElementById("preview-canvas"),d=s.getContext("2d"),u=32,h=1,v=!1,g=d.createImageData(1,1),m=(g.data,!1),f="0,0,0",p="255,255,255",w=!0,b=!1,x=[1,3,5,7,8,10,12,14,17,19,21,23,24,26,28,30,33,35,37,39,40,42,44,46,49,51,53,55,56,58,60,62],y=0,k=[];$("#brush_1").on("click",function(){e($("#brush_1"))}),document.onkeyup=function(t){66==t.which&&e($("#brush_1")),t.ctrlKey&&90==t.which&&function(){var e=y-1;imgData=k[e],d.putImageData(imgData,0,0),y>1&&(y-=1)}()},$("#canvas").css("zoom",u),$("#preview-canvas").css("zoom",h),$("#hires-limit").on("change",function(){$(this).is(":checked")?(w=!0,$(".current-colors-container").show()):(w=!1,$(".current-colors-container").hide())}),$("#zoom-level, #zoom span").text(u),$(window).on("resize load",function(){$("#container").css("width",$(window).width()+"px").css("height",$(window).height()+"px")}),$(window).on("load",function(){$("#container").scrollLeft(($("#canvas").width()*u-$(window).width())/2),$("#container").scrollTop(($("#canvas").height()*u-$(window).height())/2)});var I,z="";for(I=0;I<i.length;++I)z+='<div class="color'+(0==I?" active":"")+'" data-rgb="'+i[I]+'" style="background-color: rgba('+i[I]+',1)"></div>';$("#palette").append(z);var C=new Image;C.src="demopic.png",C.onload=function(){d.drawImage(C,0,0),n()},$("#clear").on("click",function(){d.save(),d.setTransform(1,0,0,1,0,0),d.clearRect(0,0,s.width,s.height),d.fillStyle="rgba("+f+",1)",d.fillRect(0,0,s.width,s.height),d.restore(),n()}),$(s).bind({mousedown:function(){r=d.getImageData(0,0,320,200),m=!0,c(event)},mousemove:function(){var e=t(event);$("#coor-x").text(e[0]),$("#coor-y").text(e[1]);var r=o(event);$("#charcoor-x").text(r[0]+1),$("#charcoor-y").text(r[1]+1),$("#char-overlay").css("top",r[1]*u*8+"px").css("left",r[0]*u*8+"px").css("width",8*u-1+"px").css("height",8*u-1+"px");var i=a(r);1==i.length&&(i[1]=i[0]),$("#current-colors .color1").css("background-color","rgba("+i[0]+")"),$("#current-colors .color2").css("background-color","rgba("+i[1]+")"),m&&(c(event),n())},mouseup:function(){!function(e){k[y]=e,y++}(r),m=!1}}),$(".zoom-option").on("click",function(){$(this).hasClass("zoom-in")?zoomIndex=4:zoomIndex=4==u?0:-4,$("#canvas").css("zoom",u+zoomIndex),u+=zoomIndex,$("#zoom-level, #zoom span").text(u);var e=o(event);$("#char-overlay").css("top",e[1]*u*8+"px").css("left",e[0]*u*8+"px").css("width",8*u-1+"px").css("height",8*u-1+"px"),u<4?$("#char-overlay").css("background-color","rgba(255,255,255,0.1)"):$("#char-overlay").css("background","none")}),$("#preview-canvas").on("click",function(){event.stopPropagation(),v=!0,$("#preview-canvas").addClass("active")}),$(window).click(function(){v=!1,$("#preview-canvas").removeClass("active")}),$("#preview-canvas").bind("mousewheel",function(e){var t=e.originalEvent.wheelDelta;h+t>1?($(this).css("zoom",h+.5),h+=.5,$("#preview-canvas-container h1 span em").text(h)):($(this).css("zoom",1),h=1,$("#preview-canvas-container h1 span em").text(h))}),$("#palette .color").on("click",function(){f=$(this).data("rgb"),$("#palette .color").removeClass("active"),$(".color-indicators .left-click").css("background-color","rgba("+f+",255)"),$(".color-indicators .left-click").data("rgb",f),$(this).addClass("active")}),$("#palette .color").mousedown(function(e){3==e.which&&(p=$(this).data("rgb"),$(".color-indicators .right-click").css("background-color","rgba("+p+",255)"),$(".color-indicators .right-click").data("rgb",p))}),$("#save-image").on("click",function(){var e=document.getElementById("canvas").toDataURL("image/png");window.open("about:blank","image from canvas").document.write("<img src='"+e+"' alt='from canvas'/>")})});